package main

import (
	"database/sql"
	"embed"
	"fmt"
	"html/template"
	"log"
	"net/http"
	"os/exec"
	"runtime"

	_ "github.com/microsoft/go-mssqldb"
    // @INJECT_IMPORTS
)

//go:embed templates/* assets/*
var content embed.FS

// [ì„¤ì •ê°’] ë¹Œë”ì— ì˜í•´ ì¹˜í™˜ë  ë³€ìˆ˜ë“¤
const (
	DB_SERVER = "{{DB_SERVER}}"
	DB_USER   = "{{DB_USER}}"
	DB_PW     = "{{DB_PW}}"
	DB_NAME   = "{{DB_NAME}}"
	PORT      = ":8080"
)

var db *sql.DB

// @INJECT_STRUCTS

func main() {
	// 1. MSSQL ì—°ê²° (ìœˆë„ìš° ìµœì í™”)
	connString := fmt.Sprintf("server=%s;user id=%s;password=%s;database=%s;",
		DB_SERVER, DB_USER, DB_PW, DB_NAME)

	var err error
	db, err = sql.Open("sqlserver", connString)
	if err != nil {
		log.Fatal("âŒ DB ì—°ê²° ì„¤ì • ì‹¤íŒ¨:", err)
	}
	defer db.Close()

	if err = db.Ping(); err != nil {
		log.Println("âš ï¸ DB ì—°ê²° ì‹¤íŒ¨ (ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”):", err)
	} else {
		fmt.Println("âœ… MSSQL ì—°ê²° ì„±ê³µ!")
	}

    // DB ì—°ê²° í’€ ì„¤ì • (Windows Server ìµœì í™”)
    db.SetMaxOpenConns(100)
    db.SetMaxIdleConns(10)
    // db.SetConnMaxLifetime(30 * time.Minute)

	// 2. í…œí”Œë¦¿ ë¡œë“œ (ë°”ì´ë„ˆë¦¬ ë‚´ì¥)
	tmpl, err := template.ParseFS(content, "templates/*.html")
	if err != nil {
		log.Fatal("âŒ í…œí”Œë¦¿ ë¡œë“œ ì‹¤íŒ¨:", err)
	}

	// 3. ë¼ìš°í„° (Go 1.22 Standard Mux)
	mux := http.NewServeMux()

	// [GET] ë©”ì¸ í˜ì´ì§€
	mux.HandleFunc("GET /", func(w http.ResponseWriter, r *http.Request) {
		tmpl.ExecuteTemplate(w, "index.html", nil)
	})

	// [POST] í…ŒìŠ¤íŠ¸ API (HTMX ì—°ë™ìš©)
	mux.HandleFunc("POST /api/check", func(w http.ResponseWriter, r *http.Request) {
		// ê°„ë‹¨í•œ ì„œë²„ ì‹œê°„ í™•ì¸ ì¿¼ë¦¬
		var serverTime string
		err := db.QueryRow("SELECT GETDATE()").Scan(&serverTime)
		if err != nil {
			fmt.Fprintf(w, "<div class='text-red-500'>DB ì—ëŸ¬: %v</div>", err)
			return
		}
		fmt.Fprintf(w, "<div class='text-green-600 font-bold'>DB ì—°ê²° ì •ìƒ! ì„œë²„ ì‹œê°„: %s</div>", serverTime)
	})

	// ì •ì  íŒŒì¼ ì„œë¹™
	mux.Handle("GET /assets/", http.FileServer(http.FS(content)))

    // @INJECT_ROUTES

	// 4. ì„œë²„ ì‹œì‘ ë° ë¸Œë¼ìš°ì € ìë™ ì‹¤í–‰
	fmt.Println("ğŸš€ ì„œë²„ ì‹œì‘: http://localhost" + PORT)
	openBrowser("http://localhost" + PORT)

	err = http.ListenAndServe(PORT, mux)
	if err != nil {
		log.Fatal(err)
	}
}

// ìœ í‹¸ë¦¬í‹°: ë¸Œë¼ìš°ì € ìë™ ì—´ê¸°
func openBrowser(url string) {
	var err error
	switch runtime.GOOS {
	case "windows":
		err = exec.Command("rundll32", "url.dll,FileProtocolHandler", url).Start()
	default:
		// ê°œë°œìš© (Mac/LinuxëŠ” ìƒëµ ê°€ëŠ¥)
	}
	if err != nil {
		log.Println("ë¸Œë¼ìš°ì € ì—´ê¸° ì‹¤íŒ¨:", err)
	}
}

// @INJECT_HANDLERS

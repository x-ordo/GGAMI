package main

import (
	"embed"
	"fmt"
	"html/template"
	"log"
	"net/http"
	"os/exec"
	"runtime"

	"github.com/go-chi/chi/v5"
	"github.com/go-chi/chi/v5/middleware"
	"{{.ProjectName}}/handlers"
	"{{.ProjectName}}/models"
{{- if .HasRBAC}}
	mw "{{.ProjectName}}/middleware"
{{- end}}

	"gorm.io/gorm"
	"{{.Driver.GormDriver}}"
)

//go:embed templates/* assets/*
var content embed.FS

var (
	db   *gorm.DB
	tmpl *template.Template
)

func main() {
	var err error

	// DB ì—°ê²°
{{- if eq (printf "%s" .DBType) "sqlite"}}
	dsn := fmt.Sprintf({{.Driver.DSNFormat}}, "{{.ProjectName}}")
{{- else}}
	dsn := fmt.Sprintf({{.Driver.DSNFormat}}, "{{.DBUser}}", "{{.DBPw}}", "{{.DBServer}}", "{{.DBName}}")
{{- end}}
	db, err = gorm.Open({{.Driver.DialFunc}}(dsn), &gorm.Config{})
	if err != nil {
		log.Fatal("âŒ DB ì—°ê²° ì‹¤íŒ¨:", err)
	}
	fmt.Println("âœ… DB ì—°ê²° ì„±ê³µ!")

	// AutoMigrate
	err = db.AutoMigrate(
{{- range .Models}}
		&models.{{.Name}}{},
{{- end}}
{{- if .HasRBAC}}
		&models.User{},
{{- end}}
	)
	if err != nil {
		log.Fatal("âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨:", err)
	}
	fmt.Println("âœ… í…Œì´ë¸” ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ!")

	// í…œí”Œë¦¿ ë¡œë“œ
	tmpl, err = template.ParseFS(content, "templates/*.html")
	if err != nil {
		log.Fatal("âŒ í…œí”Œë¦¿ ë¡œë“œ ì‹¤íŒ¨:", err)
	}

	// Chi ë¼ìš°í„°
	r := chi.NewRouter()
	r.Use(middleware.Logger)
	r.Use(middleware.Recoverer)

	// ì •ì  íŒŒì¼
	r.Handle("/assets/*", http.FileServer(http.FS(content)))

	// Dashboard base handler
	baseHandler := handlers.NewBaseHandler(db, tmpl)

	// ë©”ì¸ í˜ì´ì§€ â†’ ëŒ€ì‹œë³´ë“œë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
	r.Get("/", func(w http.ResponseWriter, r *http.Request) {
{{- if .HasRBAC}}
		http.Redirect(w, r, "/login", http.StatusFound)
{{- else}}
		http.Redirect(w, r, "/dashboard", http.StatusFound)
{{- end}}
	})

{{- if .HasRBAC}}
	// Auth routes (public)
	authHandler := handlers.NewAuthHandler(db, tmpl, "{{.RBAC.JWTSecret}}")
	r.Get("/login", authHandler.LoginPage)
	r.Post("/api/auth/login", authHandler.Login)
	r.Get("/register", authHandler.RegisterPage)
	r.Post("/api/auth/register", authHandler.Register)
	r.Get("/forgot-password", authHandler.ForgotPasswordPage)
	r.Post("/api/auth/forgot-password", authHandler.ForgotPassword)
	r.Get("/logout", authHandler.Logout)
{{- end}}

	// Dashboard routes
{{- if .HasRBAC}}
	r.Route("/dashboard", func(r chi.Router) {
		r.Use(mw.JWTAuth("{{.RBAC.JWTSecret}}"))
		r.Get("/", baseHandler.Dashboard)
		r.Get("/leads", baseHandler.Leads)
		r.Get("/transactions", baseHandler.Transactions)
		r.Get("/charts", baseHandler.Charts)
		r.Get("/integration", baseHandler.Integration)
		r.Get("/calendar", baseHandler.Calendar)
		r.Get("/profile", baseHandler.ProfileSettings)
		r.Post("/profile", baseHandler.ProfileSettingsUpdate)
		r.Get("/team", baseHandler.Team)
		r.Get("/billing", baseHandler.Billing)
		r.Get("/welcome", baseHandler.Welcome)
		r.Get("/blank", baseHandler.Blank)
		r.Get("/404", baseHandler.NotFound)
	})
{{- else}}
	r.Route("/dashboard", func(r chi.Router) {
		r.Get("/", baseHandler.Dashboard)
		r.Get("/leads", baseHandler.Leads)
		r.Get("/transactions", baseHandler.Transactions)
		r.Get("/charts", baseHandler.Charts)
		r.Get("/integration", baseHandler.Integration)
		r.Get("/calendar", baseHandler.Calendar)
		r.Get("/profile", baseHandler.ProfileSettings)
		r.Post("/profile", baseHandler.ProfileSettingsUpdate)
		r.Get("/team", baseHandler.Team)
		r.Get("/billing", baseHandler.Billing)
		r.Get("/welcome", baseHandler.Welcome)
		r.Get("/blank", baseHandler.Blank)
		r.Get("/404", baseHandler.NotFound)
	})
{{- end}}

	// Model routes
{{- range .Models}}
	{
		h := handlers.New{{.Name}}Handler(db, tmpl)
{{- if $.HasRBAC}}
		r.Route("/{{.NameSnake}}s", func(r chi.Router) {
			r.Use(mw.JWTAuth("{{$.RBAC.JWTSecret}}"))
			// UI routes
			r.Get("/ui/list", h.ListPage)
			r.Get("/ui/new", h.NewForm)
			r.Get("/ui/{id}/edit", h.EditForm)
			// API routes
			r.Get("/", h.List)
			r.Post("/", h.Create)
			r.Get("/{id}", h.Get)
			r.Put("/{id}", h.Update)
			r.Post("/{id}/update", h.Update)
			r.Delete("/{id}", h.Delete)
			r.Post("/{id}/delete", h.Delete)
		})
{{- else}}
		r.Route("/{{.NameSnake}}s", func(r chi.Router) {
			// UI routes
			r.Get("/ui/list", h.ListPage)
			r.Get("/ui/new", h.NewForm)
			r.Get("/ui/{id}/edit", h.EditForm)
			// API routes
			r.Get("/", h.List)
			r.Post("/", h.Create)
			r.Get("/{id}", h.Get)
			r.Put("/{id}", h.Update)
			r.Post("/{id}/update", h.Update)
			r.Delete("/{id}", h.Delete)
			r.Post("/{id}/delete", h.Delete)
		})
{{- end}}
	}
{{- end}}

	// ì„œë²„ ì‹œì‘
	addr := ":{{.Port}}"
	fmt.Printf("ğŸš€ ì„œë²„ ì‹œì‘: http://localhost%s\n", addr)
	openBrowser("http://localhost" + addr)

	if err := http.ListenAndServe(addr, r); err != nil {
		log.Fatal(err)
	}
}

func openBrowser(url string) {
	switch runtime.GOOS {
	case "windows":
		exec.Command("rundll32", "url.dll,FileProtocolHandler", url).Start()
	case "darwin":
		exec.Command("open", url).Start()
	default:
		exec.Command("xdg-open", url).Start()
	}
}
